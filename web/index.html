<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium Bounding Box to FastAPI</title>

    <!--CESIUM-->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.105/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.105/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <!--BOOTSTRAP-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="styles/styles.css"></script>

</head>

<body>
    <div id="toolbar">
        <p>Haz clic en el mapa para iniciar el 치rea, y otro clic para terminar.</p>
        <button onclick="getRoads()" id="getRoadsBtn" disabled>Descargar carreteras</button>
        <button onclick="getRoadsWebsocket()" id="getRoadsWebsocketBtn" disabled>Descargar carreteras Websocket</button>
        <button onclick="runSimulationWebsocket()" id="simWebsocketBtn" disabled>Iniciar Simulaci칩n Websocket</button>
        <button onclick="testWebsocket()" id="testWebsocketBtn">Probar Websocket</button>

        <div id="messages-websocket" style="display:block; color:rgb(235, 9, 46);"></div>
    </div>
    <div id="cesiumContainer"></div>

    <div id="spinnerOverlay" class="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <script>
        // Reemplaza con tu token de Cesium Ion
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YWQ3ZWY4ZS03NzBjLTRjNzktYTYyNy0zMTRkYmE1NmE1NDciLCJpZCI6MjgwODk3LCJpYXQiOjE3NDEwNzIzMzl9.rpQ6pVt0APCbZ_zhTJkhquCVXwmMo3unuk4ZafCea-k';

        const viewer = new Cesium.Viewer('cesiumContainer');
        let handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

        let firstPoint = null;
        let rectangleEntity = null;
        let bounds = null;

        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(-1.872093,42.912304, 5000),
            duration: 0
        });

        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(-1.603712,42.813916, 5000),
            duration: 0
        });


        let vehicleEntities = {};

        const roadStyles = {
            'highway.motorway': { color: Cesium.Color.BLUE, width: 4 },
            'highway.primary': { color: Cesium.Color.GREEN, width: 4 },
            'highway.secondary': { color: Cesium.Color.YELLOW, width: 4 },
            'highway.tertiary': { color: Cesium.Color.PURPLE, width: 4 },
            'highway.trunk': { color: Cesium.Color.ORANGE, width: 4 },
            'highway.residential': { color: Cesium.Color.WHITE, width: 4 },
            'default': { color: Cesium.Color.GRAY, width: 4 }
        };

        const velocityStyles = {
            '120': { color: Cesium.Color.BLUE, width: 4 },
            '100': { color: Cesium.Color.GREEN, width: 4 },
            '80': { color: Cesium.Color.YELLOW, width: 4 },
            '60': { color: Cesium.Color.PURPLE, width: 4 },
            '40': { color: Cesium.Color.ORANGE, width: 4 },
            '20': { color: Cesium.Color.WHITE, width: 4 },
            'default': { color: Cesium.Color.GRAY, width: 4 }
        };

        function mostrarSpinner(){
            document.getElementById('spinnerOverlay').style.display = 'block';
        }

        function ocultarSpinner(){
            document.getElementById('spinnerOverlay').style.display = 'none';
        }

        function getVelocityStyle(velocity) {

            if (velocity>119) {
                return Cesium.Color.BLUE;
            } else if (velocity>101 && velocity<=119) {
                return Cesium.Color.GREEN;
            } else if (velocity>80 && velocity<=101) {
                return Cesium.Color.YELLOW;
            } else if (velocity>60 && velocity<=80) {
                return Cesium.Color.PURPLE;
            } else if (velocity>40 && velocity<=60) {
                return Cesium.Color.ORANGE;
            } else if (velocity>20 && velocity<=40) {
                return Cesium.Color.WHITE;
            } else {
                return Cesium.Color.GRAY;
            }
        }

        function createPropertiesPanel(properties) {
    
            let descrip = `<table class="tablePorperties">`;
            for (const [key, value] of Object.entries(properties)) {
            if (key === 'enlace'|| key === 'url' || key === 'link' || key === 'source') {
                // Si el valor es un enlace, lo formateamos como un enlace HTML
                descrip = descrip + `<tr class="trproper">
                                        <td>Enlace</td>
                                        <td class="tdproper">
                                        <a href="${value}" target="_blank">Ir a Catastro</a>
                                        </td>
                                    </tr>`;
            }
            else{
                descrip = descrip + `<tr class="trproper">
                                        <td class="tdproper">${key}</td>
                                        <td class="tdproper"> ${value}</td>
                                    </tr>`;
            }
            
            }
            descrip = descrip + '</table>';
            return descrip;
        }

        function messageWebsocket(data){
            if (data.mensaje ) {
                console.log('Mensaje de prueba:', data);
                document.getElementById('messages-websocket').style.display = 'block';
                document.getElementById('messages-websocket').style.color = data.color;
                document.getElementById('messages-websocket').innerHTML = data.mensaje + "游녨";
                return;
            }
            console.log('Mensaje de prueba:', data);
        }

        handler.setInputAction(function (click) {
            const cartesian = viewer.camera.pickEllipsoid(click.position, viewer.scene.globe.ellipsoid);

            if (!cartesian) return;

            if (!firstPoint) {
                // Primer clic: iniciamos el punto
                firstPointPosition = Cesium.Cartographic.fromCartesian(cartesian);
                firstPoint = viewer.entities.add({
                    position: firstPointPosition,
                    point: {
                        pixelSize: 10,
                        color: Cesium.Color.BLUE,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                        outline: true,
                        outlineColor: Cesium.Color.BLUE,
                        outlineWidth: 2
                    }
                });
                console.log("Primer punto fijado");
            } else {
                // Segundo clic: finalizamos y calculamos el bounding box
                secondPointPosition = Cesium.Cartographic.fromCartesian(cartesian);
                secondPoint = viewer.entities.add({
                    position: secondPointPosition,
                    point: {
                        pixelSize: 10,
                        color: Cesium.Color.BLUE,    
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                        outline: true,
                        outlineColor: Cesium.Color.BLUE,
                        outlineWidth: 2
                    }
                });

                bounds = {
                    west: Math.min(firstPointPosition.longitude, secondPointPosition.longitude),
                    south: Math.min(firstPointPosition.latitude, secondPointPosition.latitude),
                    east: Math.max(firstPointPosition.longitude, secondPointPosition.longitude),
                    north: Math.max(firstPointPosition.latitude, secondPointPosition.latitude)
                };

                // Dibujar el rect치ngulo en el mapa
                if (rectangleEntity) viewer.entities.remove(rectangleEntity);

                rectangleEntity = viewer.entities.add({
                    rectangle: {
                        coordinates: Cesium.Rectangle.fromRadians(bounds.west, bounds.south, bounds.east, bounds.north),
                        material: Cesium.Color.CYAN.withAlpha(0.4),
                        outline: true,
                        outlineColor: Cesium.Color.CYAN
                    }
                });

                document.getElementById('getRoadsBtn').disabled = false;
                document.getElementById('getRoadsWebsocketBtn').disabled = false;
                document.getElementById('simWebsocketBtn').disabled = false;

                firstPoint = null; // Reiniciar para una nueva selecci칩n
            }
        }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

        function crearLineString(datosLineString,altura=0) {
            const coordenadas = datosLineString.geometry.coordinates; 
            const posiciones = coordenadas.map(coord => {
            const [lon, lat] = coord;
            return Cesium.Cartesian3.fromDegrees(lon, lat, 0);
            });

            const velocityStyle = getVelocityStyle(datosLineString.properties.velocidad_max);
            
            viewer.entities.add({
            description: createPropertiesPanel(datosLineString.properties),
            polyline: {
                positions: posiciones,
                material : velocityStyle,
                width: 3,
                clampToGround: true // Para que la l칤nea se ajuste al terreno
            }
            });
        }

        // LLAMADAS A LA APIs

        async function getRoads() {
            if (!bounds) return;
            viewer.entities.remove(rectangleEntity);
            const payload = {
                west: Cesium.Math.toDegrees(bounds.west),
                south: Cesium.Math.toDegrees(bounds.south),
                east: Cesium.Math.toDegrees(bounds.east),
                north: Cesium.Math.toDegrees(bounds.north),
                // road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "unclassified", "living_street", "service", "footway", "cycleway", "steps", "path", "track", "bridleway", "corridor", "ferry", "construction", "proposed", "raceway", "platform", "elevator", "escalator", "moving_walkway", "transit", "subway", "tram", "light_rail", "rail", "monorail"]    
                road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "living_street","trunk","trunk_link", "primary_link", "secondary_link", "tertiary_link","service"]    
            };

            try {
                mostrarSpinner()
                const response = await fetch('http://localhost:8000/get-roads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const dataSource = await response.json();

                if (!Array.isArray(dataSource)){
                    entidades = dataSource.features;  
                }
                else {
                    entidades = dataSource[0].features;
                }

                if (!entidades ) {
                    console.warn("No se encontraron entidades en el GeoJSON."); 
                    return;
                }

                for (let i = 0; i < entidades.length; i++) {
                    crearLineString(entidades[i]);
                }
              
                ocultarSpinner()

            } catch (error) {
                ocultarSpinner()
                console.error("Error:", error);
            } finally {
                ocultarSpinner();
            }
        }

        // WEBSOCKET
        // Test websocket
        async function testWebsocket() {
            
            const socket = new WebSocket('ws://localhost:8000/ws/test');
            socket.onopen = () => {
                console.log('Conectado al servidor');
            };
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje ) {
                    console.log('Mensaje de prueba:', data);
                    document.getElementById('messages-websocket').style.display = 'block';
                    document.getElementById('messages-websocket').style.color = data.color;
                    document.getElementById('messages-websocket').innerHTML = data.mensaje + "游녨";
                    return;
                }
                console.log('Mensaje de prueba:', data);
            }
        }

        async function getRoadsWebsocket(){
            if (!bounds) return;
            // Eliminar el rect치ngulo de la selecci칩n
            viewer.entities.remove(rectangleEntity);
            document.getElementById('messages-websocket').innerHTML = "Conectando al servidor...";
            const payload = {
                west: Cesium.Math.toDegrees(bounds.west),
                south: Cesium.Math.toDegrees(bounds.south),
                east: Cesium.Math.toDegrees(bounds.east),
                north: Cesium.Math.toDegrees(bounds.north),
                // road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "unclassified", "living_street", "service", "footway", "cycleway", "steps", "path", "track", "bridleway", "corridor", "ferry", "construction", "proposed", "raceway", "platform", "elevator", "escalator", "moving_walkway", "transit", "subway", "tram", "light_rail", "rail", "monorail"]    
                road_types: ["motorway", "motorway_link","motorway_junction", "primary", "secondary", "tertiary", "residential", "living_street","trunk","trunk_link", "primary_link", "secondary_link", "tertiary_link","service"]    
                
            };

            const socket = new WebSocket('ws://localhost:8000/ws/getRoads?bbox='+JSON.stringify(payload));
            socket.onopen = () => {
                console.log('Conectado al servidor');
            };
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje)    {
                    messageWebsocket(data);
                    return;
                }
                
                crearLineString(data);

            }



        }

        // Run simulation websocket
        async function runSimulationWebsocket() {
            if (!bounds) return;
            // Eliminar el rect치ngulo de la selecci칩n
            viewer.entities.remove(rectangleEntity);
            document.getElementById('messages-websocket').innerHTML = "Conectando al servidor...";
            const payload = {
                west: Cesium.Math.toDegrees(bounds.west),
                south: Cesium.Math.toDegrees(bounds.south),
                east: Cesium.Math.toDegrees(bounds.east),
                north: Cesium.Math.toDegrees(bounds.north),
                // road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "unclassified", "living_street", "service", "footway", "cycleway", "steps", "path", "track", "bridleway", "corridor", "ferry", "construction", "proposed", "raceway", "platform", "elevator", "escalator", "moving_walkway", "transit", "subway", "tram", "light_rail", "rail", "monorail"]    
                road_types: ["motorway", "motorway_link","motorway_junction", "primary", "secondary", "tertiary", "residential", "living_street","trunk","trunk_link", "primary_link", "secondary_link", "tertiary_link","service"]    
                
            };

            const socket = new WebSocket('ws://localhost:8000/ws/simulation?bbox='+JSON.stringify(payload));
            const vehicles = {}; // Diccionario para rastrear entidades

            socket.onopen = () => {
                console.log('Conectado al servidor');
            };
    
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje ) {
                    document.getElementById('messages-websocket').innerHTML = data.mensaje;
                    return;
                }
                ocultarSpinner();
                console.log('Datos de veh칤culos:', data);
                const position = Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude);
                if (!vehicles[data.id]) {
                    // Crear el veh칤culo si no existe
                    const orientation = Cesium.Transforms.headingPitchRollQuaternion(
                        position,
                        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(data.angle), 0, 0)
                    );

                    const random_number = Math.floor(Math.random() * 7) + 1;
                    let URI_Coche;
                    if (random_number === 1) {
                        URI_Coche = "coches/forales.glb";
                    } else if (random_number === 2) {
                        URI_Coche = "coches/cocheAzulCubo.glb";
                    } else if (random_number === 3) {
                        URI_Coche = "coches/cocheVerdeCubo.glb";
                    } else if (random_number === 4) {
                        URI_Coche = "coches/cocheRojoCubo.glb";
                    } else if (random_number === 5) {
                        URI_Coche = "coches/cocheAmarilloCubo.glb";
                    } else if (random_number === 6) {
                        URI_Coche = "coches/cocheMoradoCubo.glb";
                    } else if (random_number === 7) {
                        URI_Coche = "coches/cocheNegroCubo.glb"
                    }

                    

                    vehicles[data.id] = viewer.entities.add({
                        id: data.id,
                        position: position,
                        orientation: orientation,
                        description: createPropertiesPanel(data),
                        // Orientaci칩n basada en el 치ngulo de SUMO
                        // orientation: Cesium.Transforms.headingPitchRollQuaternion(
                        //     position,
                        //     new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(data.angle), 0, 0)
                        // ),
                        // point: { 
                        //     id: data.id,
                        //     pixelSize: 15, 
                        //     color: Cesium.Color.RED ,clampToGround: true,
                        //     heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND, // 칔salo si el punto est치 en terreno
                        //     disableDepthTestDistance: Number.POSITIVE_INFINITY 
                        // }
                        
                        model: {
                            uri: URI_Coche, // Ruta a tu carpeta
                            minimumPixelSize: 20,          // Para que no desaparezca al alejarse
                            // maximumScale: 20000,
                            scale: 25.0                  // Ajusta seg칰n el tama침o de tu .glb
                        },
                        label: { 
                            text: data.id, 
                            font: '10pt sans-serif',
                            fillColor: Cesium.Color.WHITE,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            pixelOffset: new Cesium.Cartesian2(0, -20) 
                        }
                    });
                } else {
                    // Actualizar posici칩n y rotaci칩n en tiempo real
                    // vehicles[data.id].position = position;
                    const position = Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude);
                    viewer.entities.getById(data.id).position = position;
                    viewer.entities.getById(data.id).orientation = Cesium.Transforms.headingPitchRollQuaternion(
                        position,
                        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(data.angle), 0, 0)
                    );

                    
                }
            }
        }

        
    </script>
</body>
    
</html>