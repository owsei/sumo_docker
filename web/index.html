<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium Bounding Box to FastAPI</title>

    <!--CESIUM-->
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.105/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.105/Build/Cesium/Widgets/widgets.css" rel="stylesheet">

    <!--BOOTSTRAP-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <link rel="stylesheet" href="styles/styles.css"></script>

</head>

<body>
    <div id="toolbar">
        <p>Haz clic en el mapa para iniciar el √°rea, y otro clic para terminar.</p>
        <!-- <button onclick="getRoads()" class="btn btn-primary" id="getRoadsBtn" disabled>Descargar carreteras</button> -->
        <button onclick="getRoadsWebsocket()" class="btn btn-primary" id="getRoadsWebsocketBtn" disabled>Descargar carreteras Websocket</button>
        <button onclick="getRoadsPamplona()" class="btn btn-primary" id="getRoadsPamplonaWebsocketBtn">Descargar carreteras Pamplona net</button>
        <button onclick="runSimulationWebsocket()" class="btn btn-primary" id="simWebsocketBtn" disabled>Iniciar Simulaci√≥n Websocket</button>
        <button onclick="testWebsocket()" class="btn btn-primary" id="testWebsocketBtn">Probar Websocket</button>

        <button onclick="removeForbiddenRoads()" class="btn btn-primary" id="removeForbiddenRoadsBtn" disabled>Quitar prohibici√≥n de carreteras</button>

        <div id="messages-websocket" style="display:block; color:rgb(235, 9, 46);"></div>
    </div>
    <div id="cesiumContainer"></div>

    <div id="spinnerOverlay" class="spinner-overlay">
        <div class="spinner"></div>
    </div>

    <div id="layer" class="floating-layer">
        <text id="num_vehicles_text">N√∫mero de veh√≠culos: </text>
        <input type="number" id="num_vehicles" value=100>
        <text id="duration_sec_text">Duraci√≥n de la simulaci√≥n: </text>
        <input type="number" id="duration_sec" value=3600>

        <div class="accordion accordion-flush" id="accordionFlushExample">
            <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingOne">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne" aria-expanded="false" aria-controls="flush-collapseOne">
                    Calles prohibidas
                </button>
                </h2>
                <div id="flush-collapseOne" class="accordion-collapse collapse" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body"><div id="forbiddenRoads"></div></div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseTwo" aria-expanded="false" aria-controls="flush-collapseTwo">
                    Calles permitidas
                </button>
                </h2>
                <div id="flush-collapseTwo" class="accordion-collapse collapse" aria-labelledby="flush-headingTwo" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body"><div id="allowedRoads"></div></div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="flush-headingThree">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseThree" aria-expanded="false" aria-controls="flush-collapseThree">
                    Simulaci√≥n
                </button>
                </h2>
                <div id="flush-collapseThree" class="accordion-collapse collapse" aria-labelledby="flush-headingThree" data-bs-parent="#accordionFlushExample">
                <div class="accordion-body">Placeholder content for this accordion, which is intended to demonstrate the <code>.accordion-flush</code> class. This is the third item's accordion body. Nothing more exciting happening here in terms of content, but just filling up the space to make it look, at least at first glance, a bit more representative of how this would look in a real-world application.</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Reemplaza con tu token de Cesium Ion
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI3YWQ3ZWY4ZS03NzBjLTRjNzktYTYyNy0zMTRkYmE1NmE1NDciLCJpZCI6MjgwODk3LCJpYXQiOjE3NDEwNzIzMzl9.rpQ6pVt0APCbZ_zhTJkhquCVXwmMo3unuk4ZafCea-k';

        var viewer = new Cesium.Viewer('cesiumContainer', {
            infoBox: true,
        });
        viewer.infoBox.frame.removeAttribute("sandbox");
        viewer.infoBox.frame.src = "about:blank";
        
        let handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);

        let firstPoint = null;
        let rectangleEntity = null;
        let bounds = null;

        viewer.camera.flyTo({
            destination: Cesium.Cartesian3.fromDegrees(-1.603712,42.813916, 5000),
            duration: 0
        });

        // const endPoint= "ws://owsei.ddns.net:8000/"
        const endPoint= "ws://localhost:8000/"

        let isDragging = false;
        let startPosition = null;
        let endPosition = null;
        let floatingRectangle = null;

        let vehicleEntities = {};
        let roadsEntities = {};

        let forbiddenRoadsArray =[];

        const roadStyles = {
            'highway.motorway': { color: Cesium.Color.BLUE, width: 4 },
            'highway.primary': { color: Cesium.Color.GREEN, width: 4 },
            'highway.secondary': { color: Cesium.Color.YELLOW, width: 4 },
            'highway.tertiary': { color: Cesium.Color.PURPLE, width: 4 },
            'highway.trunk': { color: Cesium.Color.ORANGE, width: 4 },
            'highway.residential': { color: Cesium.Color.WHITE, width: 4 },
            'default': { color: Cesium.Color.GRAY, width: 4 }
        };

        const velocityStyles = {
            '120': { color: Cesium.Color.BLUE, width: 4 },
            '100': { color: Cesium.Color.GREEN, width: 4 },
            '80': { color: Cesium.Color.YELLOW, width: 4 },
            '60': { color: Cesium.Color.PURPLE, width: 4 },
            '40': { color: Cesium.Color.ORANGE, width: 4 },
            '20': { color: Cesium.Color.WHITE, width: 4 },
            'default': { color: Cesium.Color.GRAY, width: 4 }
        };

        function mostrarSpinner(){
            document.getElementById('spinnerOverlay').style.display = 'block';
        }

        function ocultarSpinner(){
            document.getElementById('spinnerOverlay').style.display = 'none';
        }

        function setForbiddenRoads(idRoad){
            forbiddenRoadsArray.push(idRoad);
            htmlForbbidenRoads=''
            forbiddenRoadsArray.forEach(element => {
                htmlForbbidenRoads+=`<div class="alert alert-danger" role="alert">${element}</div>`;
            });
            document.getElementById('forbiddenRoads').innerHTML = htmlForbbidenRoads;
        }

        function removeForbiddenRoads(){
            forbiddenRoads.clear();
        }

        function getVelocityStyle(velocity) {

            if (velocity>119) {
                return Cesium.Color.BLUE;
            } else if (velocity>101 && velocity<=119) {
                return Cesium.Color.GREEN;
            } else if (velocity>80 && velocity<=101) {
                return Cesium.Color.YELLOW;
            } else if (velocity>60 && velocity<=80) {
                return Cesium.Color.PURPLE;
            } else if (velocity>40 && velocity<=60) {
                return Cesium.Color.ORANGE;
            } else if (velocity>20 && velocity<=40) {
                return Cesium.Color.WHITE;
            } else {
                return Cesium.Color.GRAY;
            }
        }

        function createPropertiesPanel(properties) {
    
            let descrip = `<table id="tablaProperties${properties.id}"  class="tablePorperties">`;
            for (const [key, value] of Object.entries(properties)) {
                if (key === 'enlace'|| key === 'url' || key === 'link' || key === 'source') {
                    // Si el valor es un enlace, lo formateamos como un enlace HTML
                    descrip = descrip + `<tr class="trproper">
                                            <td>Enlace</td>
                                            <td class="tdproper">
                                            <a href="${value}" target="_blank">Ir a Catastro</a>
                                            </td>
                                        </tr>`;
                }
                else{
                    descrip = descrip + `<tr class="trproper">
                                            <td class="tdproper">${key}</td>
                                            <td class="tdproper"> ${value}</td>
                                        </tr>`;
                }
                
            }
            descrip = descrip + `<tr><td> <button id="${properties.id}" class="cesium-button">
                                Prohibir ‚õî
                            </button></td></tr>`;
            descrip = descrip + '</table>';

            return descrip;
        }

        function messageWebsocket(data){
            if (data.mensaje ) {
                console.log('Mensaje de prueba:', data);
                document.getElementById('messages-websocket').style.display = 'block';
                document.getElementById('messages-websocket').style.color = data.color;
                document.getElementById('messages-websocket').innerHTML = data.mensaje + "üëç";
                return;
            }
            console.log('Mensaje de prueba:', data);
        }

        handler.setInputAction(function (click) {
            const cartesian = viewer.camera.pickEllipsoid(click.position, viewer.scene.globe.ellipsoid);

            if (!cartesian) return;

            if (!firstPoint) {
                // Primer clic: iniciamos el punto
                firstPointPosition = Cesium.Cartographic.fromCartesian(cartesian);
                firstPoint = viewer.entities.add({
                    position: firstPointPosition,
                    point: {
                        pixelSize: 10,
                        color: Cesium.Color.BLUE,
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                        outline: true,
                        outlineColor: Cesium.Color.BLUE,
                        outlineWidth: 2
                    }
                });
                console.log("Primer punto fijado");
            } else {
                // Segundo clic: finalizamos y calculamos el bounding box
                secondPointPosition = Cesium.Cartographic.fromCartesian(cartesian);
                secondPoint = viewer.entities.add({
                    position: secondPointPosition,
                    point: {
                        pixelSize: 10,
                        color: Cesium.Color.BLUE,    
                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                        outline: true,
                        outlineColor: Cesium.Color.BLUE,
                        outlineWidth: 2
                    }
                });

                bounds = {
                    west: Math.min(firstPointPosition.longitude, secondPointPosition.longitude),
                    south: Math.min(firstPointPosition.latitude, secondPointPosition.latitude),
                    east: Math.max(firstPointPosition.longitude, secondPointPosition.longitude),
                    north: Math.max(firstPointPosition.latitude, secondPointPosition.latitude)
                };

                // Dibujar el rect√°ngulo en el mapa
                if (rectangleEntity) viewer.entities.remove(rectangleEntity);

                rectangleEntity = viewer.entities.add({
                    rectangle: {
                        coordinates: Cesium.Rectangle.fromRadians(bounds.west, bounds.south, bounds.east, bounds.north),
                        material: Cesium.Color.CYAN.withAlpha(0.4),
                        outline: true,
                        outlineColor: Cesium.Color.CYAN
                    }
                });

                // document.getElementById('getRoadsBtn').disabled = false;
                document.getElementById('getRoadsWebsocketBtn').disabled = false;
                document.getElementById('getRoadsPamplonaWebsocketBtn').disabled = false;
                document.getElementById('simWebsocketBtn').disabled = false;

                firstPoint = null; // Reiniciar para una nueva selecci√≥n
            }
        }, Cesium.ScreenSpaceEventType.RIGHT_CLICK);

        // Funci√≥n que se ejecutar√° al hacer click
        function miFuncion() {
            alert('¬°Bot√≥n clickeado!');
        }
        
        function crearLineString(datosLineString,altura=0) {
            const coordenadas = datosLineString.geometry.coordinates; 
            const posiciones = coordenadas.map(coord => {
            const [lon, lat] = coord;
            return Cesium.Cartesian3.fromDegrees(lon, lat, 0);
            });

            const velocityStyle = getVelocityStyle(datosLineString.properties.velocidad_max);
            
            viewer.entities.add({
            properties: {
                id: datosLineString.properties.id,
                velocidad_max: datosLineString.properties.velocidad_max,
                prohibida: false                    
            },
            polyline: {
                positions: posiciones,
                material : velocityStyle,
                width: 3,
                clampToGround: true // Para que la l√≠nea se ajuste al terreno
            },
            description: `
                        <div id="tablaProperties${datosLineString.properties.id}"  class="tablePorperties" >
                            <p>Informaci√≥n de la entidad</p>
                            <p>ID: ${datosLineString.properties.id}</p>
                            <p>Velocidad m√°xima: ${datosLineString.properties.velocidad_max}</p>
                            <p>Prohibida: ${datosLineString.properties.prohibida}</p>
                            <button id="${datosLineString.properties.id}" class="cesium-button">
                                Prohibir ‚õî
                            </button>
                        </div>
                    `,
            });
        }

        viewer.selectedEntityChanged.addEventListener(function(selectedEntity) {
            var entityId = selectedEntity.properties.id.getValue();
            var entityProhibida = selectedEntity.properties.prohibida.getValue();
            var entityVelocidadMax = selectedEntity.properties.velocidad_max.getValue();

            if (selectedEntity) {
                setTimeout(function() {
                    var button = viewer.infoBox.frame.contentDocument.getElementById(entityId);
                    if (button) {
                        var entity = viewer.selectedEntity;
                        button.addEventListener('click', function() {
                            setForbiddenRoads(entityId);
                            entity.polyline.material = Cesium.Color.RED;
                        });
                    }
                }, 1000);
            }
        });

        // LLAMADAS A LA APIs

        async function getRoads() {
            if (!bounds) return;
            viewer.entities.remove(rectangleEntity);
            const payload = {
                west: Cesium.Math.toDegrees(bounds.west),
                south: Cesium.Math.toDegrees(bounds.south),
                east: Cesium.Math.toDegrees(bounds.east),
                north: Cesium.Math.toDegrees(bounds.north),
                // road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "unclassified", "living_street", "service", "footway", "cycleway", "steps", "path", "track", "bridleway", "corridor", "ferry", "construction", "proposed", "raceway", "platform", "elevator", "escalator", "moving_walkway", "transit", "subway", "tram", "light_rail", "rail", "monorail"]    
                road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "living_street","trunk","trunk_link", "primary_link", "secondary_link", "tertiary_link","service"]    
            };

            try {
                mostrarSpinner()
                const response = await fetch('http://localhost:8000/get-roads', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const dataSource = await response.json();

                if (!Array.isArray(dataSource)){
                    entidades = dataSource.features;  
                }
                else {
                    entidades = dataSource[0].features;
                }

                if (!entidades ) {
                    console.warn("No se encontraron entidades en el GeoJSON."); 
                    return;
                }

                for (let i = 0; i < entidades.length; i++) {
                    crearLineString(entidades[i]);
                }
              
                ocultarSpinner()

            } catch (error) {
                ocultarSpinner()
                console.error("Error:", error);
            } finally {
                ocultarSpinner();
            }
        }

        // WEBSOCKET
        // Test websocket
        async function testWebsocket() {
            
            const socket = new WebSocket(endPoint+'ws/test');
            socket.onopen = () => {
                console.log('Conectado al servidor');
            };
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje ) {
                    console.log('Mensaje de prueba:', data);
                    document.getElementById('messages-websocket').style.display = 'block';
                    document.getElementById('messages-websocket').style.color = data.color;
                    document.getElementById('messages-websocket').innerHTML = data.mensaje + "üëç";
                    return;
                }
                console.log('Mensaje de prueba:', data);
            }
        }

        async function getRoadsWebsocket(){
            if (!bounds) return;
            // Eliminar el rect√°ngulo de la selecci√≥n
            viewer.entities.remove(rectangleEntity);
            document.getElementById('messages-websocket').innerHTML = "Conectando al servidor...";
            const payload = {
                west: Cesium.Math.toDegrees(bounds.west),
                south: Cesium.Math.toDegrees(bounds.south),
                east: Cesium.Math.toDegrees(bounds.east),
                north: Cesium.Math.toDegrees(bounds.north),
                // road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "unclassified", "living_street", "service", "footway", "cycleway", "steps", "path", "track", "bridleway", "corridor", "ferry", "construction", "proposed", "raceway", "platform", "elevator", "escalator", "moving_walkway", "transit", "subway", "tram", "light_rail", "rail", "monorail"]    
                road_types: ["motorway", "motorway_link","motorway_junction", "primary", "secondary", "tertiary", "residential", "living_street","trunk","trunk_link", "primary_link", "secondary_link", "tertiary_link","service"]    
                
            };

            const socket = new WebSocket(endPoint+'ws/getRoads?bbox='+JSON.stringify(payload));
            socket.onopen = () => {
                console.log('Conectado al servidor');
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje){
                    messageWebsocket(data);
                    return;
                }
                
                crearLineString(data);
                objeto=document.getElementById("btn_"+data.properties.id);
                // document.getElementById("btn_"+data.properties.id).addEventListener('click',function ()
                // {
                //     alert(data.properties.id);
                // }); 
            }
        }   

        async function getRoadsPamplona(){

            const socket = new WebSocket(endPoint+'ws/getRoadsPamplona');
            socket.onopen = () => {
                console.log('Conectado al servidor');
            };

            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje){
                    messageWebsocket(data);
                    return;
                }
                
                crearLineString(data);
            }
        }

        // Run simulation websocket
        async function runSimulationWebsocket() {
            if (!bounds) return;
            // Eliminar el rect√°ngulo de la selecci√≥n
            viewer.entities.remove(rectangleEntity);
            document.getElementById('messages-websocket').innerHTML = "Conectando al servidor...";
            const payload = {
                west: Cesium.Math.toDegrees(bounds.west),
                south: Cesium.Math.toDegrees(bounds.south),
                east: Cesium.Math.toDegrees(bounds.east),
                north: Cesium.Math.toDegrees(bounds.north),
                // road_types: ["motorway", "motorway_link", "primary", "secondary", "tertiary", "residential", "unclassified", "living_street", "service", "footway", "cycleway", "steps", "path", "track", "bridleway", "corridor", "ferry", "construction", "proposed", "raceway", "platform", "elevator", "escalator", "moving_walkway", "transit", "subway", "tram", "light_rail", "rail", "monorail"]    
                road_types: ["motorway", "motorway_link","motorway_junction", "primary", "secondary", "tertiary", "residential", "living_street","trunk","trunk_link", "primary_link", "secondary_link", "tertiary_link","service"]
            };

            const encoded = forbiddenRoadsArray.map(road => road.replace(/#/g, '%23'));
            const forbiddenRoads = JSON.stringify(encoded);

            const num_vehicles = document.getElementById('num_vehicles').value;
            const duration_sec = document.getElementById('duration_sec').value;

            const socket = new WebSocket(endPoint+'ws/simulation?bbox='+JSON.stringify(payload)+"&forbiddenRoads="+forbiddenRoads+"&num_vehicles="+num_vehicles+"&duration_sec="+duration_sec);
            const vehicles = {}; // Diccionario para rastrear entidades

            socket.onopen = () => {
                console.log('Conectado al servidor');
            };
    
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                if (data.mensaje ) {
                    document.getElementById('messages-websocket').innerHTML = data.mensaje;
                    return;
                }
                ocultarSpinner();
                console.log('Datos de veh√≠culos:', data);
                const position = Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude);
                if (!vehicles[data.id]) {
                    // Crear el veh√≠culo si no existe
                    const orientation = Cesium.Transforms.headingPitchRollQuaternion(
                        position,
                        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(data.angle), 0, 0)
                    );

                    const random_number = Math.floor(Math.random() * 7) + 1;
                    let URI_Coche;
                    if (random_number === 1) {
                        URI_Coche = "coches/forales.glb";
                    } else if (random_number === 2) {
                        URI_Coche = "coches/cocheAzulCubo.glb";
                    } else if (random_number === 3) {
                        URI_Coche = "coches/cocheVerdeCubo.glb";
                    } else if (random_number === 4) {
                        URI_Coche = "coches/cocheRojoCubo.glb";
                    } else if (random_number === 5) {
                        URI_Coche = "coches/cocheAmarilloCubo.glb";
                    } else if (random_number === 6) {
                        URI_Coche = "coches/cocheMoradoCubo.glb";
                    } else if (random_number === 7) {
                        URI_Coche = "coches/cocheNegroCubo.glb"
                    }

                    

                    vehicles[data.id] = viewer.entities.add({
                        id: data.id,
                        position: position,
                        orientation: orientation,
                        description: createPropertiesPanel(data),
                        // Orientaci√≥n basada en el √°ngulo de SUMO
                        // orientation: Cesium.Transforms.headingPitchRollQuaternion(
                        //     position,
                        //     new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(data.angle), 0, 0)
                        // ),
                        // point: { 
                        //     id: data.id,
                        //     pixelSize: 15, 
                        //     color: Cesium.Color.RED ,clampToGround: true,
                        //     heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND, // √ösalo si el punto est√° en terreno
                        //     disableDepthTestDistance: Number.POSITIVE_INFINITY 
                        // }
                        
                        model: {
                            uri: URI_Coche, // Ruta a tu carpeta
                            minimumPixelSize: 20,          // Para que no desaparezca al alejarse
                            // maximumScale: 20000,
                            scale: 25.0                  // Ajusta seg√∫n el tama√±o de tu .glb
                        },
                        label: { 
                            text: data.id, 
                            font: '10pt sans-serif',
                            fillColor: Cesium.Color.WHITE,
                            outlineColor: Cesium.Color.BLACK,
                            outlineWidth: 2,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            pixelOffset: new Cesium.Cartesian2(0, -20) 
                        }
                    });
                } else {
                    // Actualizar posici√≥n y rotaci√≥n en tiempo real
                    // vehicles[data.id].position = position;
                    const position = Cesium.Cartesian3.fromDegrees(data.longitude, data.latitude);
                    viewer.entities.getById(data.id).position = position;
                    viewer.entities.getById(data.id).orientation = Cesium.Transforms.headingPitchRollQuaternion(
                        position,
                        new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(data.angle), 0, 0)
                    );

                    
                }
            }
        }

        
    </script>
</body>
    
</html>